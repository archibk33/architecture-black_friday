# CDN архитектура для "Мобильный мир"

полная архитектура онлайн-магазина с шардированием, репликацией, кешированием, service discovery и CDN для глобального распространения контента

## архитектура

### компоненты системы:

#### база данных (MongoDB)
- **configsvr** - конфигурационный сервер (порт 27019)
- **shard1** + реплики - первый шард с 3 копиями (порты 27018, 27028, 27038)
- **shard2** + реплики - второй шард с 3 копиями (порты 27020, 27030, 27040)
- **mongos** - маршрутизатор запросов (порт 27017)

#### кеширование
- **redis** - Redis сервер для кеширования (порт 6379)

#### service discovery
- **consul** - Consul сервер для обнаружения сервисов (порты 8500, 8600)

#### приложения
- **pymongo-api-1/2/3** - 3 экземпляра API приложения (порты 8001, 8002, 8003)
- **nginx-gateway** - API Gateway для распределения нагрузки (порт 80)

#### CDN узлы
- **cdn-europe** - CDN узел для Европы (порт 8091)
- **cdn-asia** - CDN узел для Азии (порт 8092)
- **cdn-america** - CDN узел для Америки (порт 8093)
- **global-load-balancer** - глобальный распределитель нагрузки (порты 8080, 8443)

## запуск системы

### 1. запуск всех сервисов
```bash
docker compose up -d
```

### 2. инициализация MongoDB кластера
```bash
# PowerShell (Windows)
.\scripts\mongo-init.ps1

# Bash (Linux/macOS)
./scripts/mongo-init.sh
```

### 3. проверка статуса
```bash
# статус всех контейнеров
docker compose ps

# статус CDN узлов
curl http://localhost:8091/cdn-status
curl http://localhost:8092/cdn-status
curl http://localhost:8093/cdn-status

# статус глобального балансировщика
curl http://localhost:8080/lb-status
```

## CDN функциональность

### географическая маршрутизация
система автоматически направляет пользователей к ближайшему CDN узлу:

- **Европа** (порт 8091): `http://localhost:8091`
- **Азия** (порт 8092): `http://localhost:8092`
- **Америка** (порт 8093): `http://localhost:8093`
- **Глобальный** (порт 8080): `http://localhost:8080` - автоматическая маршрутизация

### кеширование контента
- **Статические файлы** (CSS, JS, изображения): кешируются на 1 год
- **HTML файлы**: кешируются на 1 час
- **API ответы**: кешируются в Redis на 1 минуту

### отказоустойчивость
- каждый CDN узел имеет резервные серверы
- автоматическое переключение при сбоях
- географическое распределение нагрузки

## мониторинг и метрики

### CDN метрики
```bash
# метрики Европы
curl http://localhost:8091/cdn-metrics

# метрики Азии
curl http://localhost:8092/cdn-metrics

# метрики Америки
curl http://localhost:8093/cdn-metrics

# глобальные метрики
curl http://localhost:8080/global-metrics
```

### API метрики
```bash
# Статус API
curl http://localhost:8001/
curl http://localhost:8002/
curl http://localhost:8003/

# Количество документов
curl http://localhost:8001/helloDoc/count
```

##  Тестирование CDN

### 1. Тест производительности
```bash
# Тест загрузки через разные CDN узлы
time curl -s http://localhost:8091/ > /dev/null
time curl -s http://localhost:8092/ > /dev/null
time curl -s http://localhost:8093/ > /dev/null
```

### 2. Тест кеширования
```bash
# Первый запрос (медленный)
curl -w "Time: %{time_total}s\n" http://localhost:8091/css/style.css

# Второй запрос (быстрый, из кеша)
curl -w "Time: %{time_total}s\n" http://localhost:8091/css/style.css
```

### 3. Тест отказоустойчивости
```bash
# Остановка одного CDN узла
docker compose stop cdn-europe

# Проверка работы через другие узлы
curl http://localhost:8092/
curl http://localhost:8093/
```

##  Конфигурация

### CDN узлы
- **cdn-europe.conf** - конфигурация для Европы
- **cdn-asia.conf** - конфигурация для Азии
- **cdn-america.conf** - конфигурация для Америки
- **global-lb.conf** - глобальный балансировщик

### Статический контент
- **static-content/** - директория с HTML, CSS, JS файлами
- **index.html** - главная страница онлайн-магазина
- **css/style.css** - стили с CDN индикатором
- **js/main.js** - JavaScript с функциями CDN

##  Преимущества архитектуры

### Производительность
- Ускорение загрузки статического контента в 3-5 раз
-  Снижение задержек для пользователей из разных регионов
-  Gzip сжатие для экономии трафика

### Надежность
-  Автоматическое переключение между CDN узлами
-  Резервные серверы в каждом регионе
-  Мониторинг состояния всех компонентов

### Масштабируемость
-  Горизонтальное масштабирование API серверов
-  Глобальное распределение нагрузки
-  Легкое добавление новых CDN узлов

##  Результаты

После запуска системы:
-  **3 CDN узла** работают в разных регионах
-  **Глобальный балансировщик** маршрутизирует трафик
-  **Кеширование** ускоряет загрузку контента
-  **Отказоустойчивость** обеспечивает стабильную работу
-  **Мониторинг** позволяет отслеживать производительность

##  Отладка

### Логи CDN узлов
```bash
docker compose logs cdn-europe
docker compose logs cdn-asia
docker compose logs cdn-america
```

### Логи глобального балансировщика
```bash
docker compose logs global-load-balancer
```

### Проверка сетевых соединений
```bash
docker compose exec cdn-europe ping nginx-gateway
docker compose exec global-load-balancer ping cdn-europe
```
